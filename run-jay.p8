pico-8 cartridge // http://www.pico-8.com
version 32
__lua__


function _init()
	player = {}
	player.x = 1
	player.y = 1

	player.speed = 1

 player.items = 0x0
	-- player.has_key = false
	player.wand_charges = 0

	guard = {}
	guard.x = 9
	guard.y = 4
	guard.last_x = 0
	guard.last_y = 0
	guard.dx = 1
	guard.dy = 0
	guard.spr = 3
end


function _update()
	target={}
	target.x=player.x
	target.y=player.y

	local x=player.x
	local y=player.y

	if (btnp(0)) then x-=1 end
	if (btnp(1)) then x+=1 end
	if (btnp(2)) then y-=1 end
	if (btnp(3)) then y+=1 end

	if(x!=player.x or y != player.y) then
		move(x,y)
		update_guard()
	end
end

function move(x,y)
	-- apply move
	-- test passability of target
	-- in future, will need to test passability of
	-- all intermediate tiles
	printh(tostr(item_on_ground(x,y), true))


	if (passable(x,y)) then
		player.x=x
		player.y=y

		items = item_on_ground(x,y)
		printh("items: " .. tostr(items))
		if(items != false) then
			printh("updating items")
			player.items = player.items | items
			mset(x,y, 65)  -- empty floor tile
		end

	elseif (player.wand_charges>0) then
		printh("using wand on " .. x .. " " .. y)
		mset(x,y, 65)  -- empty floor tile
		player.wand_charges -= 1
	end
end

function passable(x, y)
	is_wall = fget(mget(x,y),0)
 is_locked_door = fget(mget(x,y),1)
	return not is_wall or (is_wall and is_locked_door and player.has_key)
end

function item_on_ground(x,y)
	 item_present = fget(mget(x,y),1)

		if item_present then
			flags = (fget(mget(x,y)) ^^ 0b10) >> 2
			-- knock out the "item" bit, which is 2, aka 0b10
			-- then shift left, so we have an item masked set of flags, i.e.
			-- where 0b1 is our first item, 0b10 is second, 0b100, etc.

			return flags
		else
			return false
		end
end



function update_guard()
	new_x = guard.x + guard.dx
	new_y = guard.y + guard.dy

	if(not passable(new_x,new_y)) then
		guard.dx *= -1
		guard.dy *= -1
		new_x = guard.x + guard.dx
		new_y = guard.y + guard.dy
	end

	guard.last_x = guard.x
	guard.last_y = guard.y

	guard.x = new_x
	guard.y = new_y

end


function _draw()
	cls()

	death=fget(mget(player.x,player.y),1)
	win=fget(mget(player.x,player.y),2)

 if(guard.x == player.x and
 	guard.y == player.y or
 	guard.last_x == player.x and
 	guard.last_y == player.y )
 	then
 		death = true
 end

	if win then
		print("you win",50,63,11)
		rect(0,0,127,127,11)
		rect(2,2,125,125,11)
	elseif death then
		print("game over",50,63,8)
		rect(0,0,127,127,8)
		rect(2,2,125,125,8)
	else
		map(0,0,0,0,16,16)

		spr(guard.spr,
			guard.x*8,
			guard.y*8)

		spr(1,player.x*8,player.y*8) -- don't love the magic 8

		-- debug vis
		print(player.x,0,0)
		print(player.y,24,0)
		print(tostr(player.items, true),  30, 0)

		print(fget(mget(player.x,player.y),0),0,8)
	end


end
__gfx__
00000000007007000080080000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000077777700008800008888880666666600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700070770700888888088888888600000600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000077777700898898e0089a800600000600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000006666000888888e008a9800600b00600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
007007000066660000eeeeee88888888600000600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000006006000000000008888880600000600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000006006000000000000000000666666600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
777777770000000055555555b0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
777777770000000057777775bb000000000000000000000000000000000000000000a01000000000000000000000000000000000000000000000000000000000
777777770000000057777775bbb00000aaa000009990000088800000ccc000000000410100000000000000000000000000000000000000000000000000000000
777777770000000057777575bbbb0000a0aaaaaa9099999980888888c0cccccc001000a000000000000000000000000000000000000000000000000000000000
777777770000000057777575bbbbb000aaa00a0a9990090988800808ccc00c0c00aaaa0000000000000000000000000000000000000000000000000000000000
777777770000000057777675bbbbbb0000000000000000000000000000000000001000a000000000000000000000000000000000000000000000000000000000
777777770000005057777775bbbbbbb0000000000000000000000000000000000000410100000000000000000000000000000000000000000000000000000000
777777770000000055555555bbbbbbbb000000000000000000000000000000000000a01000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000555555555555555555555555555555550000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000005aaaaaa559999995588888855cccccc50000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000005aaaaaa559999995588888855cccccc50000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000005aaaa5a559999595588885855cccc5c50000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000005aaaa5a559999595588885855cccc5c50000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000005aaaa6a559999695588886855cccc6c50000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000005aaaaaa559999995588888855cccccc50000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000555555555555555555555555555555550000000000000000000000000000000000000000000000000000000000000000
__gff__
0000020200080000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000004060a12224200000000000000000000000509112100000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
4040404040404040404040404040404000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4041414140414141414141414040444000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4041414140414141414141414142414000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4042404040414141414141414040414000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4041414140410541414141414040414000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4041414142414141414141414040414000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4041414140414141414141414040414000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4040424040404040404042404040414000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4002410241414140414141414140414000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4041414141414140414102024140414000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4041414141414142414102024140414000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4041414141414140414141414140414000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4041414040404040404040424040024000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4040404002414141414141414141414000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4043415441414141414141414141414000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4040404040404040404040404040404000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
