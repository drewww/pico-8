pico-8 cartridge // http://www.pico-8.com
version 32
__lua__


function _init()
	player = {}
	player.x = 8
	player.y = 8

	player.facing_x = 0
	player.facing_y = -1
	player.speed = 1

 world_rot = 0.75
 -- stores the movement sets. nested, first layer is player speed
 -- second layer is button index

	mov = {
		{{x=-1,y=0, facing_x=-1, facing_y=0, key=0, speed=1, rotate=-0.25},
			{x=1,y=0, facing_x=1, facing_y=0, key=1, speed=1, rotate=0.25},
			{x=0,y=-1, facing_x=0, facing_y=-1, key=2, speed=1, rotate=0},
 		{x=0,y=1, facing_x=0, facing_y=1, key=3, speed=1, rotate=0}},

		{
			{x=1,y=0, facing_x=1, facing_y=0, key=0, speed=1},
			{x=2,y=0, facing_x=1, facing_y=0, key=1, speed=3},
			{x=1,y=-1, facing_x=0, facing_y=-1, key=2, speed=2},
			{x=1,y=1, facing_x=0, facing_y=1, key=3, speed=2},
		}
			,

		{{x=-1,y=2, facing_x=0, facing_y=1, key=0, speed=2},
			{x=1,y=2, facing_x=0, facing_y=1, key=1, speed=2},
			{x=0,y=3, facing_x=0, facing_y=1, key=2, speed=3},
			{x=0,y=2, facing_x=0, facing_y=1, key=3, speed=2}}
		}

end

function rotate(x,y, anchor_x, anchor_y)

	vec_x=x-anchor_x
	vec_y=y-anchor_y

-- if(world_rot==0) then
-- 	return {x=x, y=y}
-- end


	for theta=0,world_rot/0.25 do
			vec_x *= -1

			swap = vec_y
			vec_y = vec_x
			vec_x = swap
	end
	return {x=vec_x+anchor_x, y=vec_y+anchor_y}
end

function _update()

	local x=0
	local y=0
	local speed=1
	-- move based on current move set matrix

	for i=0,3,1 do
		if (btnp(i)) then
			printh("")
			printh("button " .. i)

			if(mov[player.speed][i+1].rotate!=0) then
				world_rot = (world_rot+mov[player.speed][i+1].rotate)%1
				if(world_rot<0) then world_rot=1-world_rot end
			else

				-- rotate movement by world rot

				-- this is in graphics coords, just rotate around 0,0
				-- and then apply to player
				printh("move: " .. mov[player.speed][i+1].x .. ", " .. mov[player.speed][i+1].y)

				move_vec = rotate(mov[player.speed][i+1].x, mov[player.speed][i+1].y, 0,0)

				-- not sure why i have to flip x
				x+=move_vec.x*-1
				y+=move_vec.y

				printh("rotated: " .. move_vec.x .. ", " .. move_vec.y .. " @" .. world_rot)


			end
			-- speed=mov[player.speed][i+1].speed
		end
	end

	if(x != 0 or y !=0) then
		move(x,y,speed)
	end
end

function move(x,y,speed)
	-- apply move
	-- test passability of target
	-- in future, will need to test passability of
	-- all intermediate tiles
	target={}
	target.x=player.x + x
	target.y=player.y + y

	passable = not fget(mget(target.x,target.y),0)

	if (passable) then
		player.facing_x = x
		player.facing_y = y

		player.x+=x
		player.y+=y

		player.speed = speed
	end
end


function _draw()
	cls()

	-- gameplan
	-- iterate through all map cells.
	-- get angle to player
	-- adjust angle by world rotate
	-- draw


 camera((player.x-8)*8, (player.y-12)*8)
	for x=0,16,1 do
		for y=0,16,1 do
			s = mget(x,y)

			-- local angle = atan2(x-player.x, y-player.y)

			-- l = sqrt(x*x + y*y)
			-- new_x = flr(cos(angle)*l)*8+player.x*8
			-- new_y = flr(sin(angle)*l)*8+player.y*8

			new = rotate(x,y,player.x, player.y)

			spr(s,new.x*8,new.y*8)
		end
	end
	--
 -- map(0,0,0,0,16,16)
	--
	spr(1,player.x*8,player.y*8) -- don't love the magic 8

	-- -- debug vis
	--
	camera(0,0)
	print(player.x,0,0)
	print(player.y,16,0)
	print(player.speed, 32,0)
	print(world_rot, 40,0)

end

__gfx__
00000000007007000000008000000080000000000000008000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000777777000000008000008000000080800000808000b00000000b000000bb000000bb000000000000000000000000000000000000000000000000000
00700700070770700000008000000080000000800000000000bb00000000bb0000bbbb00000bb000000000000000000000000000000000000000000000000000
0007700007777770000000000000000000000000000000000bbbbbb00bbbbbb00bbbbbb0000bb000000000000000000000000000000000000000000000000000
0007700000666600000000000000000000000000000000000bbbbbb00bbbbbb0055bb5500bbbbbb0000000000000000000000000000000000000000000000000
00700700006666000000000000000000000000000000000005bb55500555bb50000bb00005bbbb50000000000000000000000000000000000000000000000000
000000000060060000000000000000000000000000000000005b00000000b500000bb000005bb500000000000000000000000000000000000000000000000000
00000000006006000000000000000000000000000000000000050000000050000005500000055000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
77777777000000008888888899999999aaaaaaaacccccccc00000000000000000000000000000000000000000000000000000000000000000000000000000000
77777777000000008888888899999999aaaaaaaacccccccc00000000000000000000000000000000000000000000000000000000000000000000000000000000
77777777000000008888888899999999aaaaaaaacccccccc00000000000000000000000000000000000000000000000000000000000000000000000000000000
77777777000000008888888899999999aaaaaaaacccccccc00000000000000000000000000000000000000000000000000000000000000000000000000000000
77777777000000008888888899999999aaaaaaaacccccccc00000000000000000000000000000000000000000000000000000000000000000000000000000000
77777777001000008888888899999999aaaaaaaacccccccc00000000000000000000000000000000000000000000000000000000000000000000000000000000
77777777000000008888888899999999aaaaaaaacccccccc00000000000000000000000000000000000000000000000000000000000000000000000000000000
77777777000000008888888899999999aaaaaaaacccccccc00000000000000000000000000000000000000000000000000000000000000000000000000000000
__gff__
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
4245454545454545454545454545454545000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4247474747474747474747474747474744000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4247474747474747474747474747474744000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4247474747474545454547474747474744000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4247474747474747474747474747474744000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4247424747474747474747474447474744000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4247424747474747474747444447474744000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4247424247474747474747444447474744000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4247424247474747474747444447474744000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4247424747474747474747474447474744000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4247474747474743434747474747474644000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4247474747474343434347474747474644000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4247474747474747474747474747474644000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4247474747474747474747474747474744000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4247474747474747474747474747474744000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4343434343434343434343434343434344000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
